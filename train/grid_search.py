import random
import datetime
from tqdm import tqdm
import argparse
import torch
from pprint import pprint
from config import DirConfig
from preprocessing.read_data import data_loader

from train.train_GatedCNN import TrainRevGrad


def run(opt):
    now = datetime.datetime.now().strftime("%Y%m%d_%H%M")
    result_file_path = DirConfig.result_grid_search % now

    opt.device = torch.device(opt.device)

    # Load dataset
    batch, vocab = data_loader(opt)

    with open(result_file_path, 'w', 1) as f:
        random.seed(2019)
        f.write(','.join(['embed_size', 'n_layers', 'out_chs', 'res_block_count']) + '\t' +
                ','.join(['dev_loss', 'micro', 'macro', 'accuracy']) + '\n')

        for i in tqdm(range(int(opt.begin), int(opt.end)), leave=True):

            opt.grid_search_index = i
            opt.embed_size = random.randint(100, 200)
            opt.n_layers = random.randint(5, 15)
            opt.out_chs = random.randint(64, 128)
            opt.res_block_count = random.randint(5, 10)

            train_process = TrainRevGrad(opt, batch, vocab)
            results = train_process.run()

            pprint(results)

            line_param = ','.join([
                str(opt.embed_size),
                str(opt.n_layers),
                str(opt.out_chs),
                str(opt.res_block_count)])
            line_result = ','.join([
                str('%.7f' % float(results['dev_loss'])),
                str(results['micro']),
                str(results['macro']),
                str(results['accuracy'])])
            f.write(line_param + '\t' + line_result + '\n')


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('-train', action='store_true', help='train mode')
    parser.add_argument('-test', action='store_true', help='test mode')

    # params for model
    parser.add_argument('-seq_len', type=int, default=20)
    parser.add_argument('-kernel', type=int, default=5)
    parser.add_argument('-ans_size', type=int, default=2)

    parser.add_argument('-begin', type=str, required=False, default=0)
    parser.add_argument('-end', type=str, required=False, default=500)
    parser.add_argument('-device', type=str, default='cpu')
    parser.add_argument('-n_epoch', type=int, default=50)
    parser.add_argument('-batch_size', type=int, default=32)
    parser.add_argument('-patience', type=int, default=10)
    parser.add_argument('-n_warmup_steps', type=int, default=10000)

    opt = parser.parse_args()

    run(opt)
